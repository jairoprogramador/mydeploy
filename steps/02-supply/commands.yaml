- name: "Iniciar terraform"
  description: "prepara el entorno de trabajo de terraform, descargando los proveedores y configurando el backend de estado"
  cmd: "terraform init"
  workdir: "./terraform"

- name: "Planificar terraform"
  description: "genera un plan de ejecuci칩n mostrando los cambios que se aplicar치n en la infraestructura"
  cmd: "terraform plan -var-file=\"fastdeploy.tfvars\" -out plan.out"
  workdir: "./terraform"
  templates:
    - "fastdeploy.tfvars"

- name: "Aplicar terraform"
  description: "ejecuta los cambios definidos en el plan para aprovisionar o modificar la infraestructura"
  cmd: "terraform apply 'plan.out'"
  workdir: "./terraform"

  outputs:
    - name: "azure_resource_group_name"
      description: "Devuelve el nombre del grupo de recursos creado en Azure"
      probe: azure_resource_group_name\s*=\s*"([^"]+)"

    - name: "azure_container_registry_name"
      description: "Devuelve el nombre del Azure Container Registry (ACR) creado para almacenar im치genes de contenedores"
      probe: azure_container_registry_name\s*=\s*"([^"]+)"

    - name: "azure_container_registry_login_server"
      description: "Devuelve el dominio del servidor de inicio de sesi칩n del Azure Container Registry para usarlo en el deployment"
      probe: azure_container_registry_login_server\s*=\s*"([^"]+)"

    - name: "azure_kubernetes_cluster_fqdn"
      description: "Devuelve el FQDN del cluster AKS para usar como base del ingress_host"
      probe: azure_kubernetes_cluster_fqdn\s*=\s*"([^"]+)"

    - name: "azure_kubernetes_cluster_name"
      description: "Devuelve el FQDN del cluster AKS para usar como base del ingress_host"
      probe: azure_kubernetes_cluster_name\s*=\s*"([^"]+)"

# - name: "Iniciar sesion con az"
#   description: "Configurar inicio de sesion"
#   cmd: "az login --service-principal --username $ARM_CLIENT_ID --password $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID"

# - name: "Configurar credenciales de aks"
#   description: "Configurar inicio de sesion"
#   cmd: "az aks get-credentials --resource-group ${var.azure_resource_group_name} --name ${var.azure_kubernetes_cluster_name} --overwrite-existing"

# - name: "Configura credencial con kubelogin"
#   description: "Configurar inicio de sesion"
#   cmd: "kubelogin convert-kubeconfig -l azurecli"
  