commands:

  - name: "Verificar terraform"
    description: "verifica que terraform esté instalado"
    cmd: "terraform --version"
    result: '(?m)^Terraform\s+v\d+\.\d+\.\d+$'

  - name: "Verificar kubectl"
    description: "verifica que kubectl esté instalado"
    cmd: "kubectl version --client"
    result: '(?m)^Client Version:\s+v\d+\.\d+\.\d+$'

  - name: "Verificar kubelogin"
    description: "verifica que kubelogin esté instalado"
    cmd: "kubelogin --version"
    result: '(?m)^kubelogin version'

  - name: "Verificar Azure CLI"
    description: "verifica que Azure CLI esté instalado"
    cmd: "az --version"
    result: '(?m)^azure-cli\s+\d+\.\d+\.\d+'
    
  - name: "Iniciar sesión"
    description: "Permite autenticarse en Azure CLI y obtener un token de acceso valido"
    cmd: "az login"
    
  #- name: "terraform apply bootstrap"
    #description: "we carry out the project supply bootstrap"
    #cmd: "terraform init && terraform plan -out plan.out && terraform apply 'plan.out'"
    #cmd: "pwd"
    #workdir: "./terraform/bootstrap"
    
  - name: "Iniciar terraform"
    description: "prepara el entorno de trabajo de terraform, descargando los proveedores y configurando el backend de estado"
    cmd: "terraform init"
    #cmd: "terraform init -backend-config='backend.tfvars'"
    workdir: "./terraform"

  - name: "Planificar terraform"
    description: "genera un plan de ejecución mostrando los cambios que se aplicarán en la infraestructura"
    cmd: "terraform plan -var=\"app_project_nam=${var.project_name}\" -var=\"app_team_name=${var.project_team}\" -var=\"azure_environment=${var.environment}\" -out plan.out"
    workdir: "./terraform"

  - name: "Aplicar terraform"
    description: "ejecuta los cambios definidos en el plan para aprovisionar o modificar la infraestructura"
    cmd: "terraform apply 'plan.out'"
    workdir: "./terraform"

    variables:
      - name: "azure_resource_group_name"
        description: "Devuelve el nombre del grupo de recursos creado en Azure"
        regex: azure_resource_group_name\s*=\s*"([^"]+)"

      - name: "azure_container_registry_name"
        description: "Devuelve el nombre del Azure Container Registry (ACR) creado para almacenar imágenes de contenedores"
        regex: azure_container_registry_name\s*=\s*"([^"]+)"

      - name: "azure_container_registry_login_server"
        description: "Devuelve el dominio del servidor de inicio de sesión del Azure Container Registry para usarlo en el deployment"
        regex: azure_container_registry_login_server\s*=\s*"([^"]+)"

      - name: "azure_subscription_id"
        description: "Devuelve el identificador único de la suscripción de Azure utilizado"
        regex: azure_subscription_id\s*=\s*([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})"

      - name: "azure_kubernetes_cluster_fqdn"
        description: "Devuelve el FQDN del cluster AKS para usar como base del ingress_host"
        regex: azure_kubernetes_cluster_fqdn\s*=\s*"([^"]+)"
